@model IEnumerable<ClinicSystem2.Models.VwDoctorAvailableSlot>

@{
    ViewData["Title"] = "Available Slots";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="fas fa-calendar-check"></i> Available Time Slots
    </h1>
    <div>
        <a asp-action="Index" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Doctors
        </a>
        <a asp-controller="Appointment" asp-action="Create" class="btn btn-primary">
            <i class="fas fa-plus"></i> Book Appointment
        </a>
    </div>
</div>

<div class="alert alert-info">
    <h5><i class="fas fa-info-circle"></i> Available Time Slots Information</h5>
    <p class="mb-0">
        This view shows available time slots for all active doctors. Slots are typically from 9:00 AM to 5:00 PM.
        Actual availability may vary based on existing appointments.
    </p>
</div>

<div class="row">
    @foreach (var slot in Model)
    {
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">@slot.DoctorName</h5>
                    <small class="text-muted">@slot.Specialty</small>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Available Today:</strong><br />
                        <i class="fas fa-clock text-primary"></i>
                        @slot.SlotStartTime?.ToString("hh:mm tt") - @slot.SlotEndTime?.ToString("hh:mm tt")
                    </div>

                    <div class="d-grid gap-2">
                        <a asp-controller="Appointment" asp-action="Create"
                           class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-calendar-plus"></i> Book Appointment
                        </a>
                        <button class="btn btn-outline-info btn-sm"
                                onclick="checkDoctorAvailability(@slot.DoctorId)">
                            <i class="fas fa-search"></i> Check Specific Time
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@if (!Model.Any())
{
    <div class="text-center py-5">
        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
        <h3>No Available Slots</h3>
        <p class="text-muted">There are no available time slots at the moment.</p>
        <a asp-action="Index" class="btn btn-primary">View All Doctors</a>
    </div>
}

<div class="card mt-4">
    <div class="card-header">
        <h5 class="card-title mb-0">Check Specific Availability</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <label for="doctorSelect" class="form-label">Select Doctor:</label>
                <select id="doctorSelect" class="form-select">
                    <option value="">Select a doctor...</option>
                    @foreach (var slot in Model)
                    {
                        <option value="@slot.DoctorId">@slot.DoctorName - @slot.Specialty</option>
                    }
                </select>
            </div>
            <div class="col-md-4">
                <label for="specificDateTime" class="form-label">Date & Time:</label>
                <input type="datetime-local" id="specificDateTime" class="form-control">
            </div>
            <div class="col-md-4">
                <label class="form-label">&nbsp;</label>
                <button class="btn btn-primary w-100" onclick="checkSpecificAvailability()">
                    <i class="fas fa-check"></i> Check Availability
                </button>
            </div>
        </div>
        <div id="specificAvailabilityResult" class="mt-3"></div>
    </div>
</div>

@section Scripts {
    <script>
        function checkDoctorAvailability(doctorId) {
            const dateTime = prompt('Enter date and time (YYYY-MM-DD HH:MM):');
            if (dateTime) {
                const proposedDateTime = new Date(dateTime);

                fetch(`/Doctor/CheckTimeSlotAvailability?doctorId=${doctorId}&proposedDateTime=${proposedDateTime.toISOString()}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.isAvailable) {
                            alert('The selected time slot is available!');
                        } else {
                            alert('The selected time slot is not available.');
                        }
                    });
            }
        }

        function checkSpecificAvailability() {
            const doctorId = document.getElementById('doctorSelect').value;
            const dateTime = document.getElementById('specificDateTime').value;
            const resultDiv = document.getElementById('specificAvailabilityResult');

            if (!doctorId || !dateTime) {
                alert('Please select both doctor and date/time');
                return;
            }

            const proposedDateTime = new Date(dateTime);

            fetch(`/Doctor/CheckTimeSlotAvailability?doctorId=${doctorId}&proposedDateTime=${proposedDateTime.toISOString()}`)
                .then(response => response.json())
                .then(data => {
                    if (data.isAvailable) {
                        resultDiv.innerHTML = `
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i>
                                The selected time slot is available!
                                <a href="/Appointment/Create" class="btn btn-success btn-sm ms-2">
                                    Book Now
                                </a>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-times-circle"></i>
                                The selected time slot is not available.
                                Please choose a different time.
                            </div>
                        `;
                    }
                });
        }

        // Set minimum datetime to current time
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('specificDateTime').min = now.toISOString().slice(0, 16);
        });
    </script>
}