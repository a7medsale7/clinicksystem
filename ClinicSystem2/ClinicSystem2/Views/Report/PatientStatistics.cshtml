@model IEnumerable<dynamic>

@{
    ViewData["Title"] = "Patient Statistics";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Patient Statistics</h1>
    <div>
        <a asp-action="Financial" class="btn btn-outline-primary">Financial Report</a>
        <a asp-action="DoctorPerformance" class="btn btn-outline-info">Doctor Performance</a>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">@Model.Count()</h4>
                        <p class="mb-0">Total Patients</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">@Model.Sum(x => (int)x.TotalAppointments)</h4>
                        <p class="mb-0">Total Appointments</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-calendar-alt fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">@Model.Average(x => (int)x.TotalAppointments).ToString("F1")</h4>
                        <p class="mb-0">Avg Appointments/Patient</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">@Model.Sum(x => (decimal)x.TotalPaid).ToString("C")</h4>
                        <p class="mb-0">Total Payments</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-dollar-sign fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Patient Statistics Table -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Patient Statistics Details</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Patient Name</th>
                        <th>Gender</th>
                        <th>Age</th>
                        <th>Total Appointments</th>
                        <th>Total Paid</th>
                        <th>Average Payment</th>
                        <th>Last Appointment</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var patient in Model)
                    {
                        <tr>
                            <td>
                                <strong>@patient.FullName</strong>
                                @if ((int)patient.TotalAppointments >= 10)
                                {
                                    <span class="badge bg-warning" title="Frequent Patient">
                                        <i class="fas fa-star"></i> VIP
                                    </span>
                                }
                            </td>
                            <td>
                                <span class="badge bg-secondary">@patient.Gender</span>
                            </td>
                            <td>
                                @if (patient.Age != null)
                                {
                                    <span>@patient.Age years</span>
                                }
                                else
                                {
                                    <span class="text-muted">N/A</span>
                                }
                            </td>
                            <td>
                                <span class="badge @GetAppointmentBadgeClass((int)patient.TotalAppointments)">
                                    @patient.TotalAppointments
                                </span>
                            </td>
                            <td>@(((decimal)patient.TotalPaid).ToString("C"))</td>
                            <td>
                                @{
                                    var avgPayment = (int)patient.TotalAppointments > 0 ?
                                    (decimal)patient.TotalPaid / (int)patient.TotalAppointments : 0;
                                }
                                @avgPayment.ToString("C")
                            </td>
                            <td>
                                @if (patient.LastAppointment != null)
                                {
                                    <small>@(((DateTime)patient.LastAppointment).ToString("yyyy-MM-dd"))</small>
                                }
                                else
                                {
                                    <span class="text-muted">No appointments</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Demographics Section -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Gender Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="genderChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Age Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="ageChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Gender distribution chart
        const genderData = {
            labels: ['Male', 'Female', 'Other'],
            datasets: [{
                data: [
                    @Model.Count(x => x.Gender?.ToString()?.ToLower() == "male"),
                    @Model.Count(x => x.Gender?.ToString()?.ToLower() == "female"),
                    @Model.Count(x => x.Gender?.ToString()?.ToLower() != "male" && x.Gender?.ToString()?.ToLower() != "female")
                ],
                backgroundColor: [
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(255, 206, 86, 0.8)'
                ]
            }]
        };

        // Age distribution chart (simplified)
        const ageData = {
            labels: ['0-18', '19-35', '36-50', '51-65', '65+'],
            datasets: [{
                label: 'Patients by Age',
                data: [
                    @Model.Count(x => x.Age != null && (int)x.Age <= 18),
                    @Model.Count(x => x.Age != null && (int)x.Age > 18 && (int)x.Age <= 35),
                    @Model.Count(x => x.Age != null && (int)x.Age > 35 && (int)x.Age <= 50),
                    @Model.Count(x => x.Age != null && (int)x.Age > 50 && (int)x.Age <= 65),
                    @Model.Count(x => x.Age != null && (int)x.Age > 65)
                ],
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        };

        new Chart(document.getElementById('genderChart'), {
            type: 'pie',
            data: genderData
        });

        new Chart(document.getElementById('ageChart'), {
            type: 'bar',
            data: ageData,
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    </script>
}

@functions {
    private string GetAppointmentBadgeClass(int appointmentCount)
    {
        return appointmentCount >= 10 ? "bg-warning" :
               appointmentCount >= 5 ? "bg-info" :
               appointmentCount >= 1 ? "bg-success" : "bg-secondary";
    }
}